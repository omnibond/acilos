<!DOCTYPE html>
<html>
<head>
	<title>Upload a json backup file</title>	
	<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta http-equiv="cache-control" content="no-cache">
	<meta http-equiv="pragma" content="no-cache">
	
	<link rel="stylesheet" href="app/resources/css/app.css">
	 <script data-dojo-config="async: 1, tlmSiblingOfDojo: 0, isDebug: 1, cacheBust: 1" src="dojo/dojo.js"></script>
	
</head>
<body class="bodyCSS">
   
	<script type="text/javascript">
		require([			
			'dojo/_base/declare',
			"dojo/_base/window",
			'dojo/dom-construct',
			'dojo/topic',
			'dojo/has',
			'dojo/_base/kernel',
			"dojo/_base/lang",
			"dojo/DeferredList",
			
			"dojox/mobile/RoundRectList",
			"dojox/mobile/TextBox",
			"dojox/mobile/ListItem",
			"dojox/mobile/Button",
			"dojox/mobile/Container",
			"dojox/mobile/GridLayout",
			"dojox/mobile/Pane",
			
			"dojo/_base/xhr",
			"dojo/_base/json"
			
		], function(			
			declare, 
			domWindow,
			domConstruct, 
			topic, 
			has,
			kernel, 
			lang, 
			DeferredList, 
			
			RoundRectList, 
			TextBox, 
			ListItem, 
			Button, 
			Container, 
			Grid, 
			Pane, 
			
			xhr,
			json					
		){
		
			buildLoginView = function(){
				var leftPane = new Container({
					style: "text-align: center"
				});
				domWindow.body().appendChild(leftPane.domNode);

				var isFirefox = typeof InstallTrigger !== 'undefined';   // Firefox 1.0+

				console.log("isFirefox is: ", isFirefox);

				this.fUploader = document.createElement("input");
				this.fUploader.setAttribute("type", "file");
				this.fUploader.setAttribute("name", "file[]");
				this.fUploader.setAttribute("multiple", "");
				this.fUploader.style.class = "roundedBorder5pxClass";

				if(isFirefox === true){
					this.fUploader.style.marginLeft = "5px";
				}else{
					this.fUploader.style.marginLeft = "-5px";
				}

				leftPane.domNode.appendChild(this.fUploader);

				this.response = '';
				this.jsonBackupDiv = '';
				this.serviceCredsBackupDiv = '';
				this.genericErrorDiv = '';

				var myButton = new Button({
					label: "Upload",
					style: "float: left; margin-top: 10px; margin-left: 7px",
					onClick: lang.hitch(this, function(){
						if(this.jsonBackupDiv){
							this.jsonBackupDiv.innerHTML = '';
							this.jsonBackupDiv = null;
						}

						if(this.serviceCredsBackupDiv){
							this.serviceCredsBackupDiv.innerHTML = '';
							this.serviceCredsBackupDiv = null;
						}

						if(this.genericErrorDiv){
							this.genericErrorDiv.innerHTML = '';
							this.genericErrorDiv = null;
						}

						var fd = new FormData();

						for(var x = 0; x < this.fUploader.files.length; x++){
							console.log("appending ", this.fUploader.files[x]);
							fd.append("fUploader[]", this.fUploader.files[x]);
						}

						var xhr = new XMLHttpRequest();

						xhr.onreadystatechange = lang.hitch(this, function(){
						    if(xhr.readyState == 4){
						        this.response = xhr.responseText;

						        this.response = JSON.parse(this.response);

						        var failureFlag = "false";

						        if(this.response){
						        	if(this.response['jsonBackup']){
						        		for(var y = 0; y < this.response['jsonBackup'].length; y++){
						        			if(this.response['jsonBackup'][y]['failure']){
						        				failureFlag = "true";
						        			}
								        }

								        if(this.failureFlag == "true"){
								        	this.jsonBackupDiv = domConstruct.create("div", {innerHTML: "An error occurred during the upload", style: "margin-top: 5px"});

							        		leftPane.domNode.appendChild(this.jsonBackupDiv);
								        }else{
								        	this.jsonBackupDiv = domConstruct.create("div", {innerHTML: "The upload was successful", style: "margin-top: 15px"});

							        		leftPane.domNode.appendChild(this.jsonBackupDiv);
								        }
						        	}else if(this.response['serviceCredsBackup']){
						        		if(this.response['serviceCredsBackup']['success']){
							        		this.serviceCredsBackupDiv = domConstruct.create("div", {innerHTML: this.response['serviceCredsBackup']['success'], style: "margin-top: 5px"});

							        		leftPane.domNode.appendChild(this.serviceCredsBackupDiv);
							        	}else if(this.response['serviceCredsBackup']['failure']){
							        		this.serviceCredsBackupDiv = domConstruct.create("div", {innerHTML: this.response['serviceCredsBackup']['failure'], style: "margin-top: 5px"});

							        		leftPane.domNode.appendChild(this.serviceCredsBackupDiv);
							        	}
						        	}else{
						        		this.genericErrorDiv = domConstruct.create("div", {innerHTML: "There was an error uploading the files", style: "margin-top: 5px"});

						        		leftPane.domNode.appendChild(this.genericErrorDiv);
						        	}
						        }
						    }
						});

						xhr.open("POST", "rest/v1.0/Database/uploadJsonBackupFile");
						xhr.send(fd);
					})
				});

				leftPane.domNode.appendChild(myButton.domNode);
			}
			
			buildLoginView();
		})
	</script>
</body>
</html>